databaseChangeLog:
  - changeSet:
      id: 4-add-result-target-foreign-key
      author: adetremerie
      dbms: "!sqlite"
      changes:
        - addForeignKeyConstraint:
            baseTableName: RESULT
            baseColumnNames: target_id
            constraintName: fk_result_target
            referencedTableName: TARGET
            referencedColumnNames: target_id
            onDelete: CASCADE
            onUpdate: RESTRICT
      rollback:
        - dropForeignKeyConstraint:
            baseTableName: RESULT
            constraintName: fk_result_target
  - changeSet:
      id: 4-add-result-target-foreign-key-sqlite-rebuild
      author: adetremerie
      dbms: sqlite
      preConditions:
        - onFail: HALT
        - onError: HALT
        - sqlCheck:
            expectedResult: "0"
            sql: |
              SELECT COUNT(*)
              FROM RESULT r
              LEFT JOIN TARGET t ON t.target_id = r.target_id
              WHERE t.target_id IS NULL;
      changes:
        - renameTable:
            oldTableName: RESULT
            newTableName: RESULT_old
        - createTable:
            tableName: RESULT
            columns:
                - column:
                    name: id
                    type: integer
                    autoIncrement: true
                    constraints:
                      primaryKey: true
                      primaryKeyName: pk_result
                      nullable: false
                - column:
                    name: target_id
                    type: varchar(255)
                    constraints:
                      nullable: false
                      referencedTableName: TARGET
                      referencedColumnNames: target_id
                      foreignKeyName: fk_result_target
                      deleteCascade: true
                - column:
                    name: result
                    type: varchar(255)
                    constraints:
                      nullable: false
                - column:
                    name: message
                    type: varchar(255)
                    constraints:
                      nullable: true
        - sql:
            sql: |
                INSERT INTO RESULT (id, target_id, result, message)
                SELECT id, target_id, result, message
                FROM RESULT_old;
        - dropTable:
            tableName: RESULT_old
      rollback:
        - renameTable:
            oldTableName: RESULT
            newTableName: RESULT_fk

        - createTable:
            tableName: RESULT
            columns:
              - column:
                  name: id
                  type: integer
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_result
                    nullable: false
              - column:
                  name: target_id
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: result
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: message
                  type: varchar(255)
                  constraints:
                    nullable: true
        - sql:
            sql: |
              INSERT INTO RESULT (id, target_id, result, message)
              SELECT id, target_id, result, message
              FROM RESULT_fk;
        - dropTable:
            tableName: RESULT_fk