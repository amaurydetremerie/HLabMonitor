name: Complete Release Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build:
    uses: ./.github/workflows/jobs/build-jar.yaml
    secrets: inherit

  docker:
    needs: build
    uses: ./.github/workflows/jobs/docker-build-push.yaml
    with:
      version: ${{ needs.build.outputs.version }}
    secrets: inherit

  packages:
    needs: build
    uses: ./.github/workflows/jobs/package-deb-rpm.yaml
    with:
      version: ${{ needs.build.outputs.version }}
    secrets: inherit

  release:
    needs: [build, docker, packages]
    uses: ./.github/workflows/jobs/publish-release.yaml
    with:
      version: ${{ needs.build.outputs.version }}
    secrets: inherit
    permissions:
      contents: write

  version-increment:
    needs: [build, release]
    uses: ./.github/workflows/jobs/increment-version.yaml
    with:
      current_version: ${{ needs.build.outputs.version }}
    secrets: inherit
    permissions:
      contents: write
